---
import Layout from '@/layouts/Layout.astro';
import { buttonVariants } from '@/components/ui/button';
import { Plus, FileText, Filter } from 'lucide-react';
import { DTETable } from '@/components/sii/dte-table';
import { dteService } from '@/lib/sii-api';

// Obtener parametros de filtro de la URL
const url = Astro.url;
const tipo_dte = url.searchParams.get('tipo_dte');
const estado = url.searchParams.get('estado');
const fecha_desde = url.searchParams.get('fecha_desde');
const fecha_hasta = url.searchParams.get('fecha_hasta');

// Obtener DTEs de la API con filtros
const response = await dteService.listar({
  tipo_dte: tipo_dte ? parseInt(tipo_dte) as 33 | 34 | 39 | 41 | 52 | 56 | 61 : undefined,
  estado: estado || undefined,
  fecha_desde: fecha_desde || undefined,
  fecha_hasta: fecha_hasta || undefined,
});
const dtes = response.success && response.data ? response.data : [];

const tiposDTE = {
  33: 'Factura',
  34: 'Factura Exenta',
  39: 'Boleta',
  41: 'Boleta Exenta',
  52: 'Guia Despacho',
  56: 'Nota Debito',
  61: 'Nota Credito',
};
---

<Layout title="Documentos Tributarios">
  <Fragment slot="actions">
    <div class="flex gap-2">
      <a href="/admin/dte/factura" class={buttonVariants()}>
        <Plus class="mr-2 h-4 w-4" /> Factura
      </a>
      <a href="/admin/dte/boleta" class={buttonVariants({ variant: 'outline' })}>
        <Plus class="mr-2 h-4 w-4" /> Boleta
      </a>
    </div>
  </Fragment>

  <div class="space-y-4">
    <p class="text-muted-foreground">
      Lista de documentos tributarios electronicos emitidos.
    </p>

    <!-- Filtros -->
    <div class="flex gap-4 flex-wrap">
      <select class="border rounded-md px-3 py-2 text-sm">
        <option value="">Todos los tipos</option>
        {Object.entries(tiposDTE).map(([key, value]) => (
          <option value={key}>{value}</option>
        ))}
      </select>
      <select class="border rounded-md px-3 py-2 text-sm">
        <option value="">Todos los estados</option>
        <option value="GENERADO">Generado</option>
        <option value="ENVIADO">Enviado</option>
        <option value="ACEPTADO">Aceptado</option>
        <option value="RECHAZADO">Rechazado</option>
      </select>
      <input type="date" class="border rounded-md px-3 py-2 text-sm" placeholder="Desde" />
      <input type="date" class="border rounded-md px-3 py-2 text-sm" placeholder="Hasta" />
    </div>

    <div class="rounded-xl border">
      <DTETable dtes={dtes} client:load />
    </div>
  </div>
</Layout>
