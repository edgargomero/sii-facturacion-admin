---
import {
  Building2,
  FileText,
  FolderKey,
  FileBarChart,
  Send,
  AlertTriangle,
  CheckCircle,
  Clock
} from 'lucide-react';
import Layout from '@/layouts/Layout.astro';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { OnboardingGuide } from '@/components/sii/onboarding-guide';
import { empresasService, dteService, cafService, envioService } from '@/lib/sii-api';

// Obtener datos reales de la API
const [empresasRes, dtesRes, cafsRes, enviosRes] = await Promise.all([
  empresasService.listar(),
  dteService.listar(),
  cafService.listar(),
  envioService.listar(),
]);

const empresas = empresasRes.success && empresasRes.data ? empresasRes.data : [];
const dtes = dtesRes.success && dtesRes.data ? dtesRes.data : [];
const cafs = cafsRes.success && cafsRes.data ? cafsRes.data : [];
const envios = enviosRes.success && enviosRes.data ? enviosRes.data : [];

// Calcular estadisticas del mes actual
const now = new Date();
const inicioMes = new Date(now.getFullYear(), now.getMonth(), 1);
const dtesMes = dtes.filter(d => new Date(d.created_at) >= inicioMes);
const facturadoMes = dtesMes.reduce((sum, d) => sum + d.monto_total, 0);

// CAFs por vencer (estado ACTIVO con pocos folios disponibles)
const cafsPorVencer = cafs.filter(c => c.estado === 'ACTIVO' && c.folios_disponibles < 50).length;

// Estadisticas de envios
const enviosPendientes = envios.filter(e => e.estado === 'ENVIADO').length;
const enviosAceptados = envios.filter(e => e.estado === 'ACEPTADO').length;
const enviosRechazados = envios.filter(e => e.estado === 'RECHAZADO').length;

const stats = {
  empresas: empresas.length,
  dtes_mes: dtesMes.length,
  facturado_mes: facturadoMes,
  cafs_por_vencer: cafsPorVencer,
  envios_pendientes: enviosPendientes,
  envios_aceptados: enviosAceptados,
  envios_rechazados: enviosRechazados,
};

const formatMoney = (value: number) => {
  return new Intl.NumberFormat('es-CL', {
    style: 'currency',
    currency: 'CLP',
    minimumFractionDigits: 0,
  }).format(value);
};

const cards = [
  {
    name: 'Empresas',
    value: stats.empresas,
    icon: Building2,
    href: '/admin/empresas',
    color: 'text-blue-500',
  },
  {
    name: 'DTEs este mes',
    value: stats.dtes_mes,
    icon: FileText,
    href: '/admin/dte',
    color: 'text-green-500',
  },
  {
    name: 'Facturado este mes',
    value: formatMoney(stats.facturado_mes),
    icon: FileBarChart,
    color: 'text-emerald-500',
  },
  {
    name: 'CAFs por vencer',
    value: stats.cafs_por_vencer,
    icon: FolderKey,
    href: '/admin/caf',
    color: stats.cafs_por_vencer > 0 ? 'text-yellow-500' : 'text-gray-500',
  },
];

const envioStats = [
  {
    name: 'Pendientes',
    value: stats.envios_pendientes,
    icon: Clock,
    color: 'text-yellow-500',
  },
  {
    name: 'Aceptados',
    value: stats.envios_aceptados,
    icon: CheckCircle,
    color: 'text-green-500',
  },
  {
    name: 'Rechazados',
    value: stats.envios_rechazados,
    icon: AlertTriangle,
    color: stats.envios_rechazados > 0 ? 'text-red-500' : 'text-gray-500',
  },
];
---

<Layout title="Dashboard">
  <div class="space-y-8">
    <!-- Guia de Onboarding para nuevos usuarios -->
    <OnboardingGuide client:load />

    <!-- Stats principales -->
    <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
      {cards.map((item) => (
        <div class="rounded-xl border bg-card text-card-foreground shadow hover:bg-muted/50 transition-colors">
          {item.href ? (
            <a href={item.href}>
              <div class="p-6">
                <div class="flex flex-row items-center justify-between space-y-0 pb-2">
                  <div class="tracking-tight text-sm font-medium text-muted-foreground">{item.name}</div>
                  <item.icon class={`h-5 w-5 ${item.color}`} />
                </div>
                <div class="pt-0">
                  <div class="text-2xl font-bold">{item.value}</div>
                </div>
              </div>
            </a>
          ) : (
            <div class="p-6">
              <div class="flex flex-row items-center justify-between space-y-0 pb-2">
                <div class="tracking-tight text-sm font-medium text-muted-foreground">{item.name}</div>
                <item.icon class={`h-5 w-5 ${item.color}`} />
              </div>
              <div class="pt-0">
                <div class="text-2xl font-bold">{item.value}</div>
              </div>
            </div>
          )}
        </div>
      ))}
    </div>

    <!-- Estado de Envios -->
    <section class="space-y-4">
      <h3 class="text-xl font-semibold">Estado de Envios al SII</h3>
      <div class="grid gap-4 md:grid-cols-3">
        {envioStats.map((item) => (
          <div class="rounded-xl border bg-card text-card-foreground shadow p-6">
            <div class="flex flex-row items-center justify-between">
              <div>
                <p class="text-sm text-muted-foreground">{item.name}</p>
                <p class="text-3xl font-bold">{item.value}</p>
              </div>
              <item.icon class={`h-8 w-8 ${item.color}`} />
            </div>
          </div>
        ))}
      </div>
    </section>

    <!-- Acciones Rapidas -->
    <section class="space-y-4">
      <h3 class="text-xl font-semibold">Acciones Rapidas</h3>
      <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
        <a href="/admin/dte/factura" class="rounded-xl border bg-card p-6 hover:bg-muted/50 transition-colors">
          <FileText class="h-8 w-8 text-primary mb-2" />
          <h4 class="font-semibold">Nueva Factura</h4>
          <p class="text-sm text-muted-foreground">Generar factura electronica</p>
        </a>
        <a href="/admin/dte/boleta" class="rounded-xl border bg-card p-6 hover:bg-muted/50 transition-colors">
          <FileText class="h-8 w-8 text-primary mb-2" />
          <h4 class="font-semibold">Nueva Boleta</h4>
          <p class="text-sm text-muted-foreground">Generar boleta electronica</p>
        </a>
        <a href="/admin/caf" class="rounded-xl border bg-card p-6 hover:bg-muted/50 transition-colors">
          <FolderKey class="h-8 w-8 text-primary mb-2" />
          <h4 class="font-semibold">Cargar CAF</h4>
          <p class="text-sm text-muted-foreground">Subir archivo de folios</p>
        </a>
        <a href="/admin/rcof" class="rounded-xl border bg-card p-6 hover:bg-muted/50 transition-colors">
          <FileBarChart class="h-8 w-8 text-primary mb-2" />
          <h4 class="font-semibold">Generar RCOF</h4>
          <p class="text-sm text-muted-foreground">Reporte consumo de folios</p>
        </a>
      </div>
    </section>

    <!-- Info del ambiente -->
    <section class="rounded-xl border bg-muted/30 p-4">
      <div class="flex items-center gap-2">
        <div class="h-2 w-2 rounded-full bg-yellow-500"></div>
        <span class="text-sm font-medium">Ambiente: CERTIFICACION</span>
        <span class="text-sm text-muted-foreground">- Los documentos se envian al ambiente de pruebas del SII</span>
      </div>
    </section>
  </div>
</Layout>
